BACKUP ALL CODE PHP:

==================================================================================================================================================================================================================================================================
BLADE
==================================================================================================================================================================================================================================================================


<section id="buy-tickets" class="section-with-bg">
    <div class="container" data-aos="fade-up">
        @php $totalPrice = 0; $sessionTotalPrice = 0; @endphp
        <div class="section-header">
            <h2>We are going to</h2>
            <p>Check the details of your next trip</p>
        </div>
        <div class="row justify-content-center">
            @foreach($routesInCart as $route)
                <div class="col-lg-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="card mb-5 mb-lg-0">
                        <div class="card-body">
                            <h5 class="card-title text-muted text-uppercase text-center">{{ $route->name }}</h5>
                            <hr>
                            @if($route->attractions->isNotEmpty())
                                <ul>
                                    @foreach($route->attractions as $attraction)
                                        <li>{{ $attraction->name }} € {{ $attraction->price }}</li>
                                        @php $totalPrice += $attraction->price; @endphp
                                    @endforeach
                                    <li>
                                        Fee: {{ $route->fee }}{{ fmod($route->fee, 1) !== 0 ? '%' : '' }}
                                    </li>
                                </ul>
                                <h6 class="card-price text-center">
                                    {{-- Calculate total price based on selected quantity --}}
                                    € {{ $route->total_price * ($cartQuantity[$route->id] ?? 1) }}
                                </h6>
                                <hr>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="d-flex justify-content-between mb-2">
                                        <form action="{{ route('increase-quantity', ['routeId' => $route->id]) }}" method="POST">
                                            @csrf
                                            <button type="submit" class="btn btn-info">+</button>
                                        </form>
                                        <form action="{{ route('decrease-quantity', ['routeId' => $route->id]) }}" method="POST">
                                            @csrf
                                            <button type="submit" class="btn btn-warning">-</button>
                                            <select name="selected_time" id="selected_time">
                                                <option value="8:00 - 9:00">8:00 - 9:00</option>
                                                <option value="10:00 - 11:00">10:00 - 11:00</option>
                                                <option value="12:00 - 13:00">12:00 - 13:00</option>
                                                <option value="14:00 - 15:00">14:00 - 15:00</option>
                                                <option value="16:00 - 17:00">16:00 - 17:00</option>
                                                <option value="18:00 - 19:00">18:00 - 19:00</option>
                                            </select>
                                        </form>
                                    </div>
                                    <form action="{{ route('route.removeFromCart', ['routeId' => $route->id]) }}" method="POST">
                                        @csrf
                                        @method('DELETE')
                                        <button type="submit" class="btn btn-danger">Remove from Cart</button>
                                    </form>
                                </div>
                            @else
                                <p>No attractions associated with this route.</p>
                            @endif
                        </div>
                    </div>
                </div>
            @endforeach
            @php
                $quantity = $routesInCart->count();
                session(['cart_quantity' => $quantity]);
            @endphp
            <div class="text-center" style="margin-top: 5%">
                <form action="{{ route('checkout') }}" method="POST">
                    <button type="submit" name="_token" value="{{csrf_token()}}" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#buy-ticket-modal" data-ticket-type="standard-access">Buy Now</button>
                </form>
            </div>
        </div>
    </div>
</section>



==================================================================================================================================================================================================================================================================
PurchaseController
==================================================================================================================================================================================================================================================================


<?php

namespace App\Http\Controllers;

use App\Http\Middleware\Authenticate;
use App\Models\Route;
use Illuminate\Contracts\View\View;
use Illuminate\Foundation\Application;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Psr\Container\ContainerExceptionInterface;
use Psr\Container\NotFoundExceptionInterface;

class PurchaseController extends Controller
{
    public function __construct()
    {
        $this->middleware(Authenticate::class);
    }

    public function my_cart()
    {
        return view('my_cart');
    }

    public function increaseQuantity(Request $request): RedirectResponse
{
    $currentQuantity = session('cart_quantity', 0);
    $newQuantity = $currentQuantity * 2;
    $selectedTime = $request->input('selected_time');
    
    session(['cart_quantity' => $newQuantity]);
    

    return redirect()->back()->with('success', 'Quantity increased');
}

public function decreaseQuantity(Request $request): RedirectResponse
{
    $currentQuantity = session('cart_quantity', 0);
    $newQuantity = max($currentQuantity / 2, 1); // Ensure quantity doesn't go below 1
    $selectedTime = $request->input('selected_time');

    // Handle the selected time as needed

    session(['cart_quantity' => $newQuantity]);

    return redirect()->back()->with('success', 'Quantity decreased');
}


    public function addToCart($routeId)
    {
        $route = Route::findOrFail($routeId);

        if ($route->remaining_available_slots <= 0) {
            return redirect()->back()->with('error', 'This route has no available slots.');
        }

        $cart = session()->get('cart', []);

        if (!in_array($routeId, $cart)) {
            $cart[] = $routeId;
            session()->put('cart', $cart);

            return redirect()->route('my-cart');
        }
    }

    public function removeFromCart($routeId)
    {
        $cart = session()->get('cart', []);

        if (($key = array_search($routeId, $cart)) !== false) {
            unset($cart[$key]);
            session()->put('cart', $cart);
            return redirect()->route('my-cart')->with('success', 'Route removed from cart.');
        } else {
            return redirect()->route('my-cart')->with('error', 'Route not found in cart.');
        }
    }

    public function viewCart(): View
    {
        $cart = session()->get('cart', []);
        $routesInCart = Route::whereIn('id', $cart)->get();
        return view('my_cart', compact('routesInCart'));
    }
}

==================================================================================================================================================================================================================================================================
StripeController:
==================================================================================================================================================================================================================================================================

<?php

namespace App\Http\Controllers;

use Illuminate\Http\RedirectResponse;
use Stripe\Checkout\Session;
use Stripe\Exception\ApiErrorException;
use Stripe\Stripe;

class StripeController extends Controller
{
    public function index()
    {
        return view('index');

    }

    /**
     * @throws ApiErrorException
     */
    public function checkout()
    {
        Stripe::setApiKey(env('STRIPE_SECRET_KEY'));
        $totalPrice = session('total_price');
        $cartQuantity = session('cart_quantity', 1);

        $session = Session::create([
            'line_items'    => [
                [
                    'price_data' => [
                        'currency' => 'eur',
                        'product_data' => [
                            'name'=> 'Your next trip',
                        ],
                        'unit_amount' => (float)$totalPrice * 100 * $cartQuantity
                    ],
                    'quantity' => $cartQuantity,
                ],
            ],
            'mode'  =>  'payment',
            'success_url' => route('success'),
            'cancel_url'    => route('index'),
        ]);
        return redirect() ->away($session->url);
    }

    public function success(): RedirectResponse
    {
        $invoiceId = invoice();
        confirmPurchase($invoiceId);
        decreaseAvailableSlots();
        return redirect()->intended('/my-trips');
    }
}

==================================================================================================================================================================================================================================================================
web.php
==================================================================================================================================================================================================================================================================


Route::post('/increase-quantity', [PurchaseController::class,'increaseQuantity'])->name('increase-quantity');
Route::post('/decrease-quantity', [PurchaseController::class,'decreaseQuantity'])->name('decrease-quantity');

==================================================================================================================================================================================================================================================================














































